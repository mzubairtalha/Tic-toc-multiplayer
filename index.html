<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multiplayer Tic Tac Toe</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 50px;
    }
    .message {
      margin-top: 20px;
      font-size: 18px;
    }
    input {
      margin: 10px;
    }
    #gameBoard {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 5px;
      justify-content: center;
      margin: 20px;
    }
    .cell {
      width: 100px;
      height: 100px;
      border: 1px solid #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      cursor: pointer;
    }
    .cell.taken {
      pointer-events: none;
      background-color: lightgrey;
    }
  </style>
</head>
<body>

  <h1>Tic Tac Toe - Multiplayer</h1>

  <!-- Name Entry Form -->
  <div id="nameEntry">
    <input type="text" id="playerName" placeholder="Enter your name" />
    <button id="saveNameBtn">Save Name</button>
  </div>

  <!-- Play Button (hidden initially) -->
  <div id="playSection" style="display:none;">
    <button id="playBtn">Play</button>
  </div>

  <!-- Game Board (hidden initially) -->
  <div id="gameBoard" style="display:none;">
    <div class="cell" data-cell="0"></div>
    <div class="cell" data-cell="1"></div>
    <div class="cell" data-cell="2"></div>
    <div class="cell" data-cell="3"></div>
    <div class="cell" data-cell="4"></div>
    <div class="cell" data-cell="5"></div>
    <div class="cell" data-cell="6"></div>
    <div class="cell" data-cell="7"></div>
    <div class="cell" data-cell="8"></div>
  </div>

  <div class="message" id="message"></div>

  <script>
    // Firebase Initialization
    const firebaseConfig = {
      apiKey: "AIzaSyCE5gLp99K4IUq6V-BhlmgOcTtTjjG6WpU",
      authDomain: "chat-app-9d3d2.firebaseapp.com",
      databaseURL: "https://chat-app-9d3d2-default-rtdb.firebaseio.com",
      projectId: "chat-app-9d2d2",
      storageBucket: "chat-app-9d2d2.appspot.com",
      messagingSenderId: "110218700281",
      appId: "1:110218700281:web:470b92a7e4b223a0660928",
      measurementId: "G-PZKV7JTD5K",
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let playerName;
    let playerSymbol;
    let opponentSymbol;
    let gameRef;
    let gameState = Array(9).fill(null);
    let currentPlayer = "X";  // 'X' starts by default
    let matchFound = false;

    // Save name to localStorage and display the Play button
    document.getElementById('saveNameBtn').addEventListener('click', () => {
      playerName = document.getElementById('playerName').value.trim();
      if (playerName) {
        localStorage.setItem('playerName', playerName);
        document.getElementById('nameEntry').style.display = 'none';
        document.getElementById('playSection').style.display = 'block';
        document.getElementById('message').innerText = 'Name saved! Click Play to start.';
      } else {
        alert('Please enter a name.');
      }
    });

    // Handle Play Button Click
    document.getElementById('playBtn').addEventListener('click', () => {
      if (!playerName) {
        alert('Please enter your name first.');
        return;
      }

      // Add player to Firebase matching list
      const matchingRef = database.ref('matchingList');
      matchingRef.once('value', (snapshot) => {
        const data = snapshot.val();
        if (data && Object.keys(data).length > 0) {
          // There is already a player, start the game
          const opponent = Object.keys(data)[0];
          gameRef = database.ref('games/' + playerName + "-" + opponent);
          gameRef.set({
            gameState,
            currentPlayer,
            players: {
              [playerName]: "X", 
              [opponent]: "O"
            }
          });
          matchingRef.child(opponent).remove(); // Remove opponent from matching list
          matchingRef.child(playerName).remove(); // Remove player from matching list
          startGame(playerName, opponent);
        } else {
          // No player found, wait for someone else
          matchingRef.child(playerName).set(true);
          document.getElementById('message').innerText = `Waiting for opponent...`;
        }
      });
    });

    // Function to start the game between two players
    function startGame(player, opponent) {
      document.getElementById('message').innerText = `Match found! ${player} vs ${opponent}`;
      document.getElementById('playSection').style.display = 'none';
      document.getElementById('gameBoard').style.display = 'block';
      playerSymbol = "X";
      opponentSymbol = "O";
      listenToGame();
    }

    // Function to listen to the game state
    function listenToGame() {
      gameRef.on('value', (snapshot) => {
        const gameData = snapshot.val();
        if (gameData) {
          gameState = gameData.gameState;
          currentPlayer = gameData.currentPlayer;
          updateBoard();
        }
      });
    }

    // Function to update the game board
    function updateBoard() {
      for (let i = 0; i < 9; i++) {
        const cell = document.querySelector(`.cell[data-cell='${i}']`);
        cell.innerText = gameState[i];
        if (gameState[i] !== null) {
          cell.classList.add('taken');
        } else {
          cell.classList.remove('taken');
        }
      }
      checkForWinner();
    }

    // Handle cell click
    document.getElementById('gameBoard').addEventListener('click', (event) => {
      const cell = event.target;
      const cellIndex = cell.getAttribute('data-cell');

      if (cellIndex && gameState[cellIndex] === null && currentPlayer === playerSymbol) {
        gameState[cellIndex] = currentPlayer;
        currentPlayer = currentPlayer === "X" ? "O" : "X";
        gameRef.set({ gameState, currentPlayer });
      }
    });

    // Check for a winner
    function checkForWinner() {
      const winPatterns = [
        [0, 1, 2],
        [3, 4, 5],
        [6, 7, 8],
        [0, 3, 6],
        [1, 4, 7],
        [2, 5, 8],
        [0, 4, 8],
        [2, 4, 6]
      ];

      for (let pattern of winPatterns) {
        const [a, b, c] = pattern;
        if (gameState[a] && gameState[a] === gameState[b] && gameState[a] === gameState[c]) {
          setTimeout(() => {
            alert(`${gameState[a]} wins!`);
            resetGame();
          }, 100);
          return;
        }
      }

      // Check for a draw
      if (!gameState.includes(null)) {
        setTimeout(() => {
          alert("It's a draw!");
          resetGame();
        }, 100);
      }
    }

    // Function to reset the game
    function resetGame() {
      gameState = Array(9).fill(null);
      gameRef.set({ gameState, currentPlayer });
      updateBoard();
      document.getElementById('message').innerText = "Game Over. Click Play to start a new game.";
      document.getElementById('gameBoard').style.display = 'none';
      document.getElementById('playSection').style.display = 'block';
    }

    // Wait for the page to load and check for local storage name
    window.onload = function() {
      const savedName = localStorage.getItem('playerName');
      if (savedName) {
        playerName = savedName;
        document.getElementById('nameEntry').style.display = 'none';
        document.getElementById('playSection').style.display = 'block';
        document.getElementById('message').innerText = `Welcome back, ${playerName}! Click Play to start.`;
      }
    };
  </script>

</body>
</html>
